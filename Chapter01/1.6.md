# 싱클톤 레지스트리와 오브젝트 스코프

> ### 오브젝트의 동일성과 동등성
> 자바에서는 두 개의 오브젝트가 같은가라는 말을 주의해서 써야한다.
> 두개의 오브젝트가 완전히 같은 동일한 오브젝트라고 말하는 것과 동일한 정보를 담고 있는 오브젝트라고 말하는 것은 분명한 차이가 있다.
전자를 `동일성 비교(==)`, 후자를 `동등성 비교(equals())`하고 한다.
> <br><br>
> 동일성 (Identity) : 두 객체가 완전히 같을 경우 <br>
> 동등성 (Equality) : 두 객체가 같은 정보를 같고 있을 경우


```java
DaoFactory factory = new DaoFactory();

// 두 userDao가 다르다.
UserDao userDao1 = factory.userDao();
UserDao userDao2 = factory.userDao();
```

```java
ApplicationContext context = new AnnotationConfigApplicationContext(DaoFactory.class);

// 두 userDao가 같다.
UserDao userDao3 = context.getBean("userDao", UserDao.class);
UserDao userDao4 = context.getBean("userDao", UserDao.class);
```

- ApplcationContext를 사용하는 경우 같은 객체가 반환된다.
- 그 이유는 스프링은 기본적으로 별다른 설정을 하지 않으면 내부에서 생성하는 빈 오브젝트를 모두 `싱글톤`으로 만들기 때문이다.
  여기서 싱글톤이라는 것은 디자인패턴에 나오는 싱글턴과 개념이 비슷하지만 구현방법이 확연히다르다.

### 싱글톤으로 빈을 만드는 이유
스프링이 주로 적용되는 대상이 자바 엔터프라이즈 기술을 사용하는 서버환경이기 때문이다.
클라이언트 요청일 올때마다 새로운 오브젝트를 만든다고 가정해보자.
요청 한번에 10개의 오브젝트를 만들어야하고, 초당 1000개의 요청이 들어온다면 초당 10000개의 오브젝트를 만들어야한다.
아무리 자바의 오브젝트 생성과 GC의 성능이 좋아졌다고 한들 이렇게 부하가 걸리면 서버가 감당하기 힘들다.

## 싱글톤 패턴의 한계
```java
public class UserDao{
    private static UserDao INSTANCE;
    ...
    private UserDao(ConnetionMaker connetionMaker) {
        this.connetionMaker = connetionMaker;
    }
    
    public static synchronized UserDao getInstance() {
        if(INSTANCE == null) {
            INSTANCE == new UserDao(...);
        }
        
        return INSTANCE;
    }
}
```
- 위는 간단히 구현한 싱글톤 코드이다.
- 먼저 DaoFactory에서 UserDao를 생성해 ConnectionMaker 오브젝트를 넣어주는 것이 불가능해졌다.

그리고 다음과 같은 일반적인 문제들이 있다.

### 1. private 생성자를 갖고 있기 때문에 상속할 수 없다.
- 객체지향의 장점인 상속과 이를 이용한 다형성을 적용할 수 없다.

### 2. 싱글톤은 테스트하기 힘들다.
- 싱글톤은 만들어지는 방식이 제한적이기 때문에 테스트에 사용될 때 목 오브젝트 등으로 대체하기가 힘들다.
- 초기화 과정에서 생성자등을 통해 오브젝트를 다이나믹하게 주입하기도 힘들다.

### 3. 서버 환경에서 싱글톤이 하나만 만들어지는 것을 보장하지 못한다.
- 서버에서 클래스 로더를 어떻게 구성하고 있느냐에 따라서 싱글톤 클래스임에도 하나 이상의 오브젝트가 만들어 질 수 있다.

### 4. 싱글톤의 사용은 전역 상태를 만들 수 있기 때문에 바람직하지 못하다.
- 아무 객체나 자유롭게 접근하고 수정하고 공유하는 전역 상태를 갖는 것은
  객체지향 프로그래밍에서는 권장되지 않는 프로그래밍 모델이다.

## 싱글톤 레지스트리
자바의 기본적인 싱글톤 패턴의 구현 방식에는 여러가지 단점이 있기에
스프링은 직접 싱글톤 형태의 오브젝트를 만들고 관리하는 기능을 제공한다. 그것이 바로 `싱글톤 레지스트리(singleton registry)`다.
싱글톤 레지스트리는 스태틱 메소드와 private 생성자를 사용해야하는 비정상적인 클래스가 아니라 평범한 자바 클래스를 싱글톤으로 활용하게 해준다.

### 싱글톤과 오브젝트 상태
- 기본적으로 싱글톤이 멀티스레드 환경에서 서비스 형태의 오브젝트로 사용되는 경우에는 상태정보를 내부에 갖고 있지 않는 `무상태(stateless)`방식으로 만들어져야 한다.
- 무상태 방식으로 만들기 위해서는 파라미터와 로컬변수, 리턴값등을 이용하면 된다. 메소드 파라미터나, 메소드 안에서 생성되는 로컬 변수는 매번 새로운 값을 저장할 독립적인 공간이 만들어지기 때문에 싱글톤이라고 해도 여러 스레드 변수의 값을 덮어쓸 일은 없다.
- 하지만, 자신이 사용하는 다른 싱글톤 빈을 저장하려는 용도라면 인스턴스 변수를 사용해도 좋다. 스프링이 한 번 초기화해주고 나면 이후에는 수정되지 않기 때문에 멀티스레드 환경에서 사용해도 아무런 문제가 없다.

### 스프링 빈의 스코프
- 스프링이 관리하는 오브젝트, 즉 빈이 생성되고, 존재하고, 적용되는 범위를 빈의 `스코프(scope)`라고 한다. 스프링 빈의 기본 스코프는 싱글톤이다.
- 경우에 따라 싱글톤 외에 다른 스코프를 가질수 있다. (prototype, request, session...)
